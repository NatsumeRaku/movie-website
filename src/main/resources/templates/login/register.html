<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>用户注册界面</title>
    <link th:href="@{/login/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/login/css/signin.css}" rel="stylesheet">
    <style>
        .form-signin {
            max-width: 400px;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        .success-message {
            color: green;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-link {
            color: #007bff;
            text-decoration: none;
        }
        .btn-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="text-center">
    <form class="form-signin" id="registerForm">
        <img class="mb-4" th:src="@{/login/img/login.jpg}" width="72px" height="72px">
        <h1 class="h3 mb-3 font-weight-normal">用户注册</h1>
        
        <!-- 注册结果提示框 -->
        <div id="alertMessage" class="alert" style="display: none;"></div>
        
        <div class="form-group">
            <input type="text" id="username" name="username" class="form-control" placeholder="用户名" required autofocus>
            <div id="usernameError" class="error-message"></div>
            <div id="usernameSuccess" class="success-message"></div>
        </div>
        

        
        <div class="form-group">
            <input type="password" id="password" name="password" class="form-control" placeholder="密码" required>
            <div id="passwordError" class="error-message"></div>
        </div>
        
        <div class="form-group">
            <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="确认密码" required>
            <div id="confirmPasswordError" class="error-message"></div>
        </div>
        
        <button class="btn btn-lg btn-primary btn-block" type="submit" id="registerBtn">注册</button>
        
        <div class="mt-3">
            <a href="/login" class="btn-link">已有账号？立即登录</a>
        </div>
        
        <p class="mt-5 mb-3 text-muted">Copyright© 2025-2026</p>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const usernameInput = document.getElementById('username');

            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const registerBtn = document.getElementById('registerBtn');
            const alertMessage = document.getElementById('alertMessage');

            // 显示提示信息
            function showAlert(message, type) {
                // 使用浏览器弹窗显示消息
                alert(message);
            }

            // 显示字段错误信息
            function showFieldError(fieldId, message) {
                const errorDiv = document.getElementById(fieldId + 'Error');
                const successDiv = document.getElementById(fieldId + 'Success');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                if (successDiv) successDiv.style.display = 'none';
            }

            // 显示字段成功信息
            function showFieldSuccess(fieldId, message) {
                const errorDiv = document.getElementById(fieldId + 'Error');
                const successDiv = document.getElementById(fieldId + 'Success');
                if (successDiv) {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                }
                errorDiv.style.display = 'none';
            }

            // 清除字段提示信息
            function clearFieldMessages(fieldId) {
                const errorDiv = document.getElementById(fieldId + 'Error');
                const successDiv = document.getElementById(fieldId + 'Success');
                errorDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
            }

            // 检查用户名是否可用
            function checkUsername() {
                const username = usernameInput.value.trim();
                if (username.length < 3) {
                    showFieldError('username', '用户名至少3个字符');
                    return;
                }
                
                fetch('/api/auth/check-username', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        showFieldSuccess('username', '用户名可用');
                    } else {
                        showFieldError('username', '用户名已存在');
                    }
                })
                .catch(error => {
                    showFieldError('username', '检查用户名时出错');
                });
            }



            // 验证密码
            function validatePassword() {
                const password = passwordInput.value;
                if (password.length < 6) {
                    showFieldError('password', '密码至少6个字符');
                    return false;
                }
                clearFieldMessages('password');
                return true;
            }

            // 验证确认密码
            function validateConfirmPassword() {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                if (password !== confirmPassword) {
                    showFieldError('confirmPassword', '两次输入的密码不一致');
                    return false;
                }
                clearFieldMessages('confirmPassword');
                return true;
            }

            // 事件监听
            usernameInput.addEventListener('blur', checkUsername);

            passwordInput.addEventListener('blur', validatePassword);
            confirmPasswordInput.addEventListener('blur', validateConfirmPassword);

            // 表单提交
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // 基本验证
                if (!username || !password || !confirmPassword) {
                    showAlert('请填写所有字段', 'danger');
                    return;
                }

                if (!validatePassword() || !validateConfirmPassword()) {
                    return;
                }

                // 禁用提交按钮
                registerBtn.disabled = true;
                registerBtn.textContent = '注册中...';

                // 提交注册请求
                fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('注册成功！点击确定跳转到登录页面', 'success');
                        setTimeout(() => {
                            window.location.href = '/login';
                        });
                    } else {
                        showAlert(data.message || '注册失败', 'danger');
                    }
                })
                .catch(error => {
                    showAlert('注册时发生错误，请稍后重试', 'danger');
                })
                .finally(() => {
                    registerBtn.disabled = false;
                    registerBtn.textContent = '注册';
                });
            });
        });
    </script>
</body>
</html>